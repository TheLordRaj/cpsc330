
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Lecture 12: Feature importances &#8212; CPSC 330 Applied Machine Learning</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lecture 13: Feature engineering and feature selection" href="13_feature-engineering-selection.html" />
    <link rel="prev" title="Lecture 11: Ensembles" href="11_ensembles.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/UBC-CS-logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">CPSC 330 Applied Machine Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Things you should know
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../docs/README.html">
   CPSC 330 Documents
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Lectures
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_intro.html">
   Lecture 1: Course Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_decision-trees.html">
   Lecture 2: Terminology, Baselines, Decision Trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_ml-fundamentals.html">
   Lecture 3: Machine Learning Fundamentals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_kNNs-SVM-RBF.html">
   Lecture 4:
   <span class="math notranslate nohighlight">
    \(k\)
   </span>
   -Nearest Neighbours and SVM RBFs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_preprocessing-pipelines.html">
   Lecture 5: Preprocessing and
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06_column-transformer-text-feats.html">
   Lecture 6:
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   <code class="docutils literal notranslate">
    <span class="pre">
     ColumnTransformer
    </span>
   </code>
   and Text Features
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_linear-models.html">
   Lecture 7: Linear Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_hyperparameter-optimization.html">
   Lecture 8: Hyperparameter Optimization and Optimization Bias
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_classification-metrics.html">
   Lecture 9: Classification Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10_regression-metrics.html">
   Lecture 10: Regression Evaluation Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11_ensembles.html">
   Lecture 11: Ensembles
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Lecture 12: Feature importances
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13_feature-engineering-selection.html">
   Lecture 13: Feature engineering and feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15_K-Means.html">
   Lecture 15: K-Means Clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16_DBSCAN-hierarchical.html">
   Lecture 16: DBSCAN and Hierarchical Clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="17_recommender-systems.html">
   Lecture 17: Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="18_natural-language-processing.html">
   Lecture 18: Introduction to natural language processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="19_intro_to_computer-vision.html">
   Lecture 19: Multi-class classification and introduction to computer vision
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="20_time-series.html">
   Lecture 20: Time series
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="21_survival-analysis.html">
   Lecture 21: Survival analysis
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Attribution
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../attribution.html">
   Attributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../LICENSE.html">
   LICENSE
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Varada Kolhatkar, CPSC 330 2022-23<br>Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/UBC-CS/cpsc330/master?urlpath=tree/lectures/12_feat-importances.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/lectures/12_feat-importances.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports-announcements-los">
   Imports, announcements, LOs
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#learning-outcomes">
     Learning outcomes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#announcement">
     Announcement
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#let-s-separate-x-and-y">
     Let’s separate
     <code class="docutils literal notranslate">
      <span class="pre">
       X
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       y
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#let-s-identify-feature-types">
     Let’s identify feature types
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-does-output-depend-upon-the-input">
     How does output depend upon the input?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simplefeature-correlations">
     SimpleFeature correlations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-importances-in-linear-models">
   Feature importances in linear models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpreting-coefficients-of-different-types-of-features">
     Interpreting coefficients of different types of features.
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ordinal-features">
     Ordinal features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-features">
     Categorical features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpreting-coefficients-of-numeric-features">
     Interpreting coefficients of numeric features
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-showing-how-can-we-interpret-coefficients-of-scaled-features">
       Example showing how can we interpret coefficients of scaled features.
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interim-summary">
     Interim summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transparency-and-explainability-of-ml-models">
   Transparency and explainability of ML models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#discussion">
     Discussion
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#why-do-we-care-about-transparency-and-interpretability">
     Why do we care about transparency and interpretability?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-is-model-interpretability">
     What is model interpretability?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#do-we-have-class-imbalance">
     Do we have class imbalance?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#break-5-min">
   Break (5 min)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Feature importances in linear models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-interpretability-beyond-linear-models">
   Model interpretability beyond linear models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#feature-importances-activity">
     Feature importances activity
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sklearn-feature-importances">
     <code class="docutils literal notranslate">
      <span class="pre">
       sklearn
      </span>
     </code>
     <code class="docutils literal notranslate">
      <span class="pre">
       feature_importances_
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#decision-tre-feature-importances">
       Decision tre feature importances
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#random-forest-feature-importances">
       Random forest feature importances
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#key-point">
     Key point
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-can-we-get-feature-importances-for-non-sklearn-models">
     How can we get feature importances for non
     <code class="docutils literal notranslate">
      <span class="pre">
       sklearn
      </span>
     </code>
     models?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shap-shapley-additive-explanations">
     SHAP  (SHapley Additive exPlanations)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#our-focus">
       Our focus
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-plots">
   SHAP plots
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#force-plots">
     Force plots
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-with-prediction-50k">
     Example with prediction &lt;=50K
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Example with prediction &gt;50K
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-feature-importance-using-shap">
     Global feature importance using SHAP
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dependence-plot">
     Dependence plot
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#summary-plot">
     Summary plot
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-tools">
     Other tools
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#why-do-we-want-this-information">
       Why do we want this information?
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Lecture 12: Feature importances</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports-announcements-los">
   Imports, announcements, LOs
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#learning-outcomes">
     Learning outcomes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#announcement">
     Announcement
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data">
   Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#let-s-separate-x-and-y">
     Let’s separate
     <code class="docutils literal notranslate">
      <span class="pre">
       X
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       y
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#let-s-identify-feature-types">
     Let’s identify feature types
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-does-output-depend-upon-the-input">
     How does output depend upon the input?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simplefeature-correlations">
     SimpleFeature correlations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-importances-in-linear-models">
   Feature importances in linear models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpreting-coefficients-of-different-types-of-features">
     Interpreting coefficients of different types of features.
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ordinal-features">
     Ordinal features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#categorical-features">
     Categorical features
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interpreting-coefficients-of-numeric-features">
     Interpreting coefficients of numeric features
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-showing-how-can-we-interpret-coefficients-of-scaled-features">
       Example showing how can we interpret coefficients of scaled features.
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#interim-summary">
     Interim summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transparency-and-explainability-of-ml-models">
   Transparency and explainability of ML models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#discussion">
     Discussion
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#why-do-we-care-about-transparency-and-interpretability">
     Why do we care about transparency and interpretability?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-is-model-interpretability">
     What is model interpretability?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#do-we-have-class-imbalance">
     Do we have class imbalance?
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#break-5-min">
   Break (5 min)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Feature importances in linear models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-interpretability-beyond-linear-models">
   Model interpretability beyond linear models
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#feature-importances-activity">
     Feature importances activity
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sklearn-feature-importances">
     <code class="docutils literal notranslate">
      <span class="pre">
       sklearn
      </span>
     </code>
     <code class="docutils literal notranslate">
      <span class="pre">
       feature_importances_
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#decision-tre-feature-importances">
       Decision tre feature importances
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#random-forest-feature-importances">
       Random forest feature importances
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#key-point">
     Key point
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-can-we-get-feature-importances-for-non-sklearn-models">
     How can we get feature importances for non
     <code class="docutils literal notranslate">
      <span class="pre">
       sklearn
      </span>
     </code>
     models?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shap-shapley-additive-explanations">
     SHAP  (SHapley Additive exPlanations)
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#our-focus">
       Our focus
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#shap-plots">
   SHAP plots
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#force-plots">
     Force plots
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example-with-prediction-50k">
     Example with prediction &lt;=50K
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Example with prediction &gt;50K
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-feature-importance-using-shap">
     Global feature importance using SHAP
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dependence-plot">
     Dependence plot
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#summary-plot">
     Summary plot
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-tools">
     Other tools
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#why-do-we-want-this-information">
       Why do we want this information?
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <p><img alt="" src="../_images/330-banner.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="lecture-12-feature-importances">
<h1>Lecture 12: Feature importances<a class="headerlink" href="#lecture-12-feature-importances" title="Permalink to this headline">#</a></h1>
<p>UBC 2022-23</p>
<p>Instructor: Varada Kolhatkar</p>
<section id="imports-announcements-los">
<h2>Imports, announcements, LOs<a class="headerlink" href="#imports-announcements-los" title="Permalink to this headline">#</a></h2>
<section id="imports">
<h3>Imports<a class="headerlink" href="#imports" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;code/.&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">plotting_functions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span><span class="p">,</span> <span class="n">make_column_transformer</span>
<span class="kn">from</span> <span class="nn">sklearn.dummy</span> <span class="kn">import</span> <span class="n">DummyClassifier</span><span class="p">,</span> <span class="n">DummyRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">GridSearchCV</span><span class="p">,</span>
    <span class="n">RandomizedSearchCV</span><span class="p">,</span>
    <span class="n">cross_val_score</span><span class="p">,</span>
    <span class="n">cross_validate</span><span class="p">,</span>
    <span class="n">train_test_split</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">OrdinalEncoder</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span><span class="p">,</span> <span class="n">SVR</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</section>
<section id="learning-outcomes">
<h3>Learning outcomes<a class="headerlink" href="#learning-outcomes" title="Permalink to this headline">#</a></h3>
<p>From this lecture, students are expected to be able to:</p>
<ul class="simple">
<li><p>Interpret the coefficients of linear regression for ordinal, one-hot encoded categorical, and scaled numeric features.</p></li>
<li><p>Explain why interpretability is important in ML.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">feature_importances_</span></code> attribute of <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> models and interpret its output.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">eli5</span></code> to get feature importances of non <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> models and interpret its output.</p></li>
<li><p>Apply SHAP to assess feature importances and interpret model predictions.</p></li>
<li><p>Explain force plot, summary plot, and dependence plot produced with shapely values.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="announcement">
<h3>Announcement<a class="headerlink" href="#announcement" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Midterm is next week.</p>
<ul>
<li><p>Bring your laptop. Make sure that it’s fully charged.</p></li>
<li><p>Bring your UBC ID Card.</p></li>
</ul>
</li>
<li><p>HW5 is available.</p></li>
<li><p>My OH on Thursday has been cancelled. I’ll hold OH on Tuesday instead.</p></li>
</ul>
</section>
</section>
<section id="data">
<h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h2>
<p>In the first part of this lecture, we’ll be using <a class="reference external" href="https://www.kaggle.com/c/home-data-for-ml-course/">Kaggle House Prices dataset</a>, the dataset we used in lecture 10. As usual, to run this notebook you’ll need to download the data. Unzip the data into a subdirectory called <code class="docutils literal notranslate"><span class="pre">data</span></code>. For this dataset, train and test have already been separated. We’ll be working with the train portion in this lecture.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/housing-kaggle/train.csv&quot;</span><span class="p">)</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Id</th>
      <th>MSSubClass</th>
      <th>MSZoning</th>
      <th>LotFrontage</th>
      <th>LotArea</th>
      <th>Street</th>
      <th>Alley</th>
      <th>LotShape</th>
      <th>LandContour</th>
      <th>Utilities</th>
      <th>...</th>
      <th>PoolArea</th>
      <th>PoolQC</th>
      <th>Fence</th>
      <th>MiscFeature</th>
      <th>MiscVal</th>
      <th>MoSold</th>
      <th>YrSold</th>
      <th>SaleType</th>
      <th>SaleCondition</th>
      <th>SalePrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>302</th>
      <td>303</td>
      <td>20</td>
      <td>RL</td>
      <td>118.0</td>
      <td>13704</td>
      <td>Pave</td>
      <td>NaN</td>
      <td>IR1</td>
      <td>Lvl</td>
      <td>AllPub</td>
      <td>...</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2006</td>
      <td>WD</td>
      <td>Normal</td>
      <td>205000</td>
    </tr>
    <tr>
      <th>767</th>
      <td>768</td>
      <td>50</td>
      <td>RL</td>
      <td>75.0</td>
      <td>12508</td>
      <td>Pave</td>
      <td>NaN</td>
      <td>IR1</td>
      <td>Lvl</td>
      <td>AllPub</td>
      <td>...</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Shed</td>
      <td>1300</td>
      <td>7</td>
      <td>2008</td>
      <td>WD</td>
      <td>Normal</td>
      <td>160000</td>
    </tr>
    <tr>
      <th>429</th>
      <td>430</td>
      <td>20</td>
      <td>RL</td>
      <td>130.0</td>
      <td>11457</td>
      <td>Pave</td>
      <td>NaN</td>
      <td>IR1</td>
      <td>Lvl</td>
      <td>AllPub</td>
      <td>...</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>3</td>
      <td>2009</td>
      <td>WD</td>
      <td>Normal</td>
      <td>175000</td>
    </tr>
    <tr>
      <th>1139</th>
      <td>1140</td>
      <td>30</td>
      <td>RL</td>
      <td>98.0</td>
      <td>8731</td>
      <td>Pave</td>
      <td>NaN</td>
      <td>IR1</td>
      <td>Lvl</td>
      <td>AllPub</td>
      <td>...</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>5</td>
      <td>2007</td>
      <td>WD</td>
      <td>Normal</td>
      <td>144000</td>
    </tr>
    <tr>
      <th>558</th>
      <td>559</td>
      <td>60</td>
      <td>RL</td>
      <td>57.0</td>
      <td>21872</td>
      <td>Pave</td>
      <td>NaN</td>
      <td>IR2</td>
      <td>HLS</td>
      <td>AllPub</td>
      <td>...</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>8</td>
      <td>2008</td>
      <td>WD</td>
      <td>Normal</td>
      <td>175000</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 81 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>The prediction task is predicting <code class="docutils literal notranslate"><span class="pre">SalePrice</span></code> given features related to properties.</p></li>
<li><p>Note that the target is numeric, not categorical.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1314, 81)
</pre></div>
</div>
</div>
</div>
<section id="let-s-separate-x-and-y">
<h3>Let’s separate <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code><a class="headerlink" href="#let-s-separate-x-and-y" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SalePrice&quot;</span><span class="p">])</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;SalePrice&quot;</span><span class="p">]</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SalePrice&quot;</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s2">&quot;SalePrice&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="let-s-identify-feature-types">
<h3>Let’s identify feature types<a class="headerlink" href="#let-s-identify-feature-types" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">]</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;BedroomAbvGr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KitchenAbvGr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LotFrontage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LotArea&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OverallQual&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OverallCond&quot;</span><span class="p">,</span>
    <span class="s2">&quot;YearBuilt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;YearRemodAdd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MasVnrArea&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtFinSF1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtFinSF2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtUnfSF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TotalBsmtSF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1stFlrSF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2ndFlrSF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LowQualFinSF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GrLivArea&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtFullBath&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtHalfBath&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FullBath&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HalfBath&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TotRmsAbvGrd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Fireplaces&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GarageYrBlt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GarageCars&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GarageArea&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WoodDeckSF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OpenPorchSF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EnclosedPorch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;3SsnPorch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ScreenPorch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PoolArea&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MiscVal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;YrSold&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ordinal_features_reg</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ExterQual&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ExterCond&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtQual&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtCond&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HeatingQC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KitchenQual&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FireplaceQu&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GarageQual&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GarageCond&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PoolQC&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Po&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Fa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Gd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ex&quot;</span><span class="p">,</span>
<span class="p">]</span>  <span class="c1"># if N/A it will just impute something, per below</span>
<span class="n">ordering_ordinal_reg</span> <span class="o">=</span> <span class="p">[</span><span class="n">ordering</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ordinal_features_reg</span><span class="p">)</span>
<span class="n">ordering_ordinal_reg</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
 [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ordinal_features_oth</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;BsmtExposure&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtFinType1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BsmtFinType2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Functional&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Fence&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">ordering_ordinal_oth</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;No&quot;</span><span class="p">,</span> <span class="s2">&quot;Mn&quot;</span><span class="p">,</span> <span class="s2">&quot;Av&quot;</span><span class="p">,</span> <span class="s2">&quot;Gd&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;Unf&quot;</span><span class="p">,</span> <span class="s2">&quot;LwQ&quot;</span><span class="p">,</span> <span class="s2">&quot;Rec&quot;</span><span class="p">,</span> <span class="s2">&quot;BLQ&quot;</span><span class="p">,</span> <span class="s2">&quot;ALQ&quot;</span><span class="p">,</span> <span class="s2">&quot;GLQ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;Unf&quot;</span><span class="p">,</span> <span class="s2">&quot;LwQ&quot;</span><span class="p">,</span> <span class="s2">&quot;Rec&quot;</span><span class="p">,</span> <span class="s2">&quot;BLQ&quot;</span><span class="p">,</span> <span class="s2">&quot;ALQ&quot;</span><span class="p">,</span> <span class="s2">&quot;GLQ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Sal&quot;</span><span class="p">,</span> <span class="s2">&quot;Sev&quot;</span><span class="p">,</span> <span class="s2">&quot;Maj2&quot;</span><span class="p">,</span> <span class="s2">&quot;Maj1&quot;</span><span class="p">,</span> <span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="s2">&quot;Min2&quot;</span><span class="p">,</span> <span class="s2">&quot;Min1&quot;</span><span class="p">,</span> <span class="s2">&quot;Typ&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;MnWw&quot;</span><span class="p">,</span> <span class="s2">&quot;GdWo&quot;</span><span class="p">,</span> <span class="s2">&quot;MnPrv&quot;</span><span class="p">,</span> <span class="s2">&quot;GdPrv&quot;</span><span class="p">],</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">categorical_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="nb">set</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ordinal_features_reg</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ordinal_features_oth</span><span class="p">)</span>
    <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">drop_features</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">categorical_features</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Exterior1st&#39;,
 &#39;MasVnrType&#39;,
 &#39;Utilities&#39;,
 &#39;BldgType&#39;,
 &#39;LandSlope&#39;,
 &#39;MiscFeature&#39;,
 &#39;SaleType&#39;,
 &#39;Exterior2nd&#39;,
 &#39;GarageFinish&#39;,
 &#39;RoofStyle&#39;,
 &#39;RoofMatl&#39;,
 &#39;LotShape&#39;,
 &#39;Alley&#39;,
 &#39;Heating&#39;,
 &#39;Electrical&#39;,
 &#39;CentralAir&#39;,
 &#39;GarageType&#39;,
 &#39;Condition1&#39;,
 &#39;SaleCondition&#39;,
 &#39;LandContour&#39;,
 &#39;LotConfig&#39;,
 &#39;HouseStyle&#39;,
 &#39;Condition2&#39;,
 &#39;MSSubClass&#39;,
 &#39;Neighborhood&#39;,
 &#39;MoSold&#39;,
 &#39;MSZoning&#39;,
 &#39;Street&#39;,
 &#39;Foundation&#39;,
 &#39;PavedDrive&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span><span class="p">,</span> <span class="n">make_column_transformer</span>

<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">),</span> <span class="n">StandardScaler</span><span class="p">())</span>
<span class="n">ordinal_transformer_reg</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;most_frequent&quot;</span><span class="p">),</span>
    <span class="n">OrdinalEncoder</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="n">ordering_ordinal_reg</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">ordinal_transformer_oth</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;most_frequent&quot;</span><span class="p">),</span>
    <span class="n">OrdinalEncoder</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="n">ordering_ordinal_oth</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
    <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">ordinal_transformer_reg</span><span class="p">,</span> <span class="n">ordinal_features_reg</span><span class="p">),</span>
    <span class="p">(</span><span class="n">ordinal_transformer_oth</span><span class="p">,</span> <span class="n">ordinal_features_oth</span><span class="p">),</span>
    <span class="p">(</span><span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;drop&#39;: &#39;drop&#39;,
 &#39;pipeline-1&#39;: Pipeline(steps=[(&#39;simpleimputer&#39;, SimpleImputer(strategy=&#39;median&#39;)),
                 (&#39;standardscaler&#39;, StandardScaler())]),
 &#39;pipeline-2&#39;: Pipeline(steps=[(&#39;simpleimputer&#39;, SimpleImputer(strategy=&#39;most_frequent&#39;)),
                 (&#39;ordinalencoder&#39;,
                  OrdinalEncoder(categories=[[&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;],
                                             [&#39;Po&#39;, &#39;Fa&#39;, &#39;TA&#39;, &#39;Gd&#39;, &#39;Ex&#39;]]))]),
 &#39;pipeline-3&#39;: Pipeline(steps=[(&#39;simpleimputer&#39;, SimpleImputer(strategy=&#39;most_frequent&#39;)),
                 (&#39;ordinalencoder&#39;,
                  OrdinalEncoder(categories=[[&#39;NA&#39;, &#39;No&#39;, &#39;Mn&#39;, &#39;Av&#39;, &#39;Gd&#39;],
                                             [&#39;NA&#39;, &#39;Unf&#39;, &#39;LwQ&#39;, &#39;Rec&#39;, &#39;BLQ&#39;,
                                              &#39;ALQ&#39;, &#39;GLQ&#39;],
                                             [&#39;NA&#39;, &#39;Unf&#39;, &#39;LwQ&#39;, &#39;Rec&#39;, &#39;BLQ&#39;,
                                              &#39;ALQ&#39;, &#39;GLQ&#39;],
                                             [&#39;Sal&#39;, &#39;Sev&#39;, &#39;Maj2&#39;, &#39;Maj1&#39;,
                                              &#39;Mod&#39;, &#39;Min2&#39;, &#39;Min1&#39;, &#39;Typ&#39;],
                                             [&#39;NA&#39;, &#39;MnWw&#39;, &#39;GdWo&#39;, &#39;MnPrv&#39;,
                                              &#39;GdPrv&#39;]]))]),
 &#39;pipeline-4&#39;: Pipeline(steps=[(&#39;simpleimputer&#39;,
                  SimpleImputer(fill_value=&#39;missing&#39;, strategy=&#39;constant&#39;)),
                 (&#39;onehotencoder&#39;,
                  OneHotEncoder(handle_unknown=&#39;ignore&#39;, sparse=False))])}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ohe_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;pipeline-4&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">new_columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">numeric_features</span> <span class="o">+</span> <span class="n">ordinal_features_reg</span> <span class="o">+</span> <span class="n">ordinal_features_oth</span> <span class="o">+</span> <span class="n">ohe_columns</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_columns</span>
<span class="p">)</span>
<span class="n">X_train_enc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BedroomAbvGr</th>
      <th>KitchenAbvGr</th>
      <th>LotFrontage</th>
      <th>LotArea</th>
      <th>OverallQual</th>
      <th>OverallCond</th>
      <th>YearBuilt</th>
      <th>YearRemodAdd</th>
      <th>MasVnrArea</th>
      <th>BsmtFinSF1</th>
      <th>...</th>
      <th>Street_Pave</th>
      <th>Foundation_BrkTil</th>
      <th>Foundation_CBlock</th>
      <th>Foundation_PConc</th>
      <th>Foundation_Slab</th>
      <th>Foundation_Stone</th>
      <th>Foundation_Wood</th>
      <th>PavedDrive_N</th>
      <th>PavedDrive_P</th>
      <th>PavedDrive_Y</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>302</th>
      <td>0.154795</td>
      <td>-0.222647</td>
      <td>2.312501</td>
      <td>0.381428</td>
      <td>0.663680</td>
      <td>-0.512408</td>
      <td>0.993969</td>
      <td>0.840492</td>
      <td>0.269972</td>
      <td>-0.961498</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>767</th>
      <td>1.372763</td>
      <td>-0.222647</td>
      <td>0.260890</td>
      <td>0.248457</td>
      <td>-0.054669</td>
      <td>1.285467</td>
      <td>-1.026793</td>
      <td>0.016525</td>
      <td>-0.573129</td>
      <td>0.476092</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>429</th>
      <td>0.154795</td>
      <td>-0.222647</td>
      <td>2.885044</td>
      <td>0.131607</td>
      <td>-0.054669</td>
      <td>-0.512408</td>
      <td>0.563314</td>
      <td>0.161931</td>
      <td>-0.573129</td>
      <td>1.227559</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1139</th>
      <td>0.154795</td>
      <td>-0.222647</td>
      <td>1.358264</td>
      <td>-0.171468</td>
      <td>-0.773017</td>
      <td>-0.512408</td>
      <td>-1.689338</td>
      <td>-1.679877</td>
      <td>-0.573129</td>
      <td>0.443419</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>558</th>
      <td>0.154795</td>
      <td>-0.222647</td>
      <td>-0.597924</td>
      <td>1.289541</td>
      <td>0.663680</td>
      <td>-0.512408</td>
      <td>0.828332</td>
      <td>0.598149</td>
      <td>-0.573129</td>
      <td>0.354114</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1041</th>
      <td>1.372763</td>
      <td>-0.222647</td>
      <td>-0.025381</td>
      <td>-0.127107</td>
      <td>-0.054669</td>
      <td>2.184405</td>
      <td>-0.165485</td>
      <td>0.743555</td>
      <td>0.843281</td>
      <td>-0.090231</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1122</th>
      <td>0.154795</td>
      <td>-0.222647</td>
      <td>-0.025381</td>
      <td>-0.149788</td>
      <td>-1.491366</td>
      <td>-2.310284</td>
      <td>-0.496757</td>
      <td>-1.389065</td>
      <td>-0.573129</td>
      <td>-0.961498</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1346</th>
      <td>0.154795</td>
      <td>-0.222647</td>
      <td>-0.025381</td>
      <td>1.168244</td>
      <td>0.663680</td>
      <td>1.285467</td>
      <td>-0.099230</td>
      <td>0.888961</td>
      <td>-0.573129</td>
      <td>-0.314582</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1406</th>
      <td>-1.063173</td>
      <td>-0.222647</td>
      <td>0.022331</td>
      <td>-0.203265</td>
      <td>-0.773017</td>
      <td>1.285467</td>
      <td>0.033279</td>
      <td>1.082835</td>
      <td>-0.573129</td>
      <td>0.467379</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1389</th>
      <td>0.154795</td>
      <td>-0.222647</td>
      <td>-0.454788</td>
      <td>-0.475099</td>
      <td>-0.054669</td>
      <td>0.386530</td>
      <td>-0.993666</td>
      <td>-1.679877</td>
      <td>-0.573129</td>
      <td>-0.144686</td>
      <td>...</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>1314 rows × 263 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1314, 263)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">())</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">lr_pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fit_time</th>
      <th>score_time</th>
      <th>test_score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.017569</td>
      <td>0.005400</td>
      <td>0.834450</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.018072</td>
      <td>0.005120</td>
      <td>0.810031</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.017607</td>
      <td>0.005100</td>
      <td>0.831653</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.018748</td>
      <td>0.007358</td>
      <td>0.843537</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.018675</td>
      <td>0.005405</td>
      <td>0.548802</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="how-does-output-depend-upon-the-input">
<h3>How does output depend upon the input?<a class="headerlink" href="#how-does-output-depend-upon-the-input" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>How does the prediction change as a function of a particular feature?</p></li>
<li><p>If the model is bad interpretability does not make sense.</p></li>
</ul>
</section>
<section id="simplefeature-correlations">
<h3>SimpleFeature correlations<a class="headerlink" href="#simplefeature-correlations" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Let’s look at the correlations between various features with other features and the target in our encoded data (first row/column).</p></li>
<li><p>In simple terms here is how you can interpret correlations between two variables <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span>:</p>
<ul>
<li><p>If <span class="math notranslate nohighlight">\(Y\)</span> goes up when <span class="math notranslate nohighlight">\(X\)</span> goes up, we say <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> are positively correlated.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(Y\)</span> goes down when <span class="math notranslate nohighlight">\(X\)</span> goes up, we say <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> are negatively correlated.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(Y\)</span> is unchanged when <span class="math notranslate nohighlight">\(X\)</span> changes, we say <span class="math notranslate nohighlight">\(X\)</span> and <span class="math notranslate nohighlight">\(Y\)</span> are uncorrelated.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">y_train</span><span class="p">,</span> <span class="n">X_train_enc</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cor</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/12_feat-importances_28_0.png" src="../_images/12_feat-importances_28_0.png" />
</div>
</div>
<ul class="simple">
<li><p>We can immediately see that <code class="docutils literal notranslate"><span class="pre">SalePrice</span></code> is highly correlated with <code class="docutils literal notranslate"><span class="pre">OverallQual</span></code>.</p></li>
<li><p>This is an early hint that <code class="docutils literal notranslate"><span class="pre">OverallQual</span></code> is a useful feature in predicting <code class="docutils literal notranslate"><span class="pre">SalePrice</span></code>.</p></li>
<li><p>However, this approach is <strong>extremely simplistic</strong>.</p>
<ul>
<li><p>It only looks at each feature in isolation.</p></li>
<li><p>It only looks at linear associations:</p>
<ul>
<li><p>What if <code class="docutils literal notranslate"><span class="pre">SalePrice</span></code> is high when <code class="docutils literal notranslate"><span class="pre">BsmtFullBath</span></code> is 2 or 3, but low when it’s 0, 1, or 4? They might seem uncorrelated.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">y_train</span><span class="p">,</span> <span class="n">X_train_enc</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">cor</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/12_feat-importances_30_0.png" src="../_images/12_feat-importances_30_0.png" />
</div>
</div>
<ul class="simple">
<li><p>Looking at this diagram also tells us the relationship between features.</p>
<ul>
<li><p>For example, <code class="docutils literal notranslate"><span class="pre">1stFlrSF</span></code> and <code class="docutils literal notranslate"><span class="pre">TotalBsmtSF</span></code> are highly correlated.</p></li>
<li><p>Do we need both of them?</p></li>
<li><p>If our model says <code class="docutils literal notranslate"><span class="pre">1stFlrSF</span></code> is very important and <code class="docutils literal notranslate"><span class="pre">TotalBsmtSF</span></code> is very unimportant, do we trust those values?</p></li>
<li><p>Maybe <code class="docutils literal notranslate"><span class="pre">TotalBsmtSF</span></code> only “becomes important” if <code class="docutils literal notranslate"><span class="pre">1stFlrSF</span></code> is removed.</p></li>
<li><p>Sometimes the opposite happens: a feature only becomes important if another feature is <em>added</em>.</p></li>
</ul>
</li>
</ul>
<p><br><br><br><br></p>
</section>
</section>
<section id="feature-importances-in-linear-models">
<h2>Feature importances in linear models<a class="headerlink" href="#feature-importances-in-linear-models" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>With linear regression we can look at the <em>coefficients</em> for each feature.</p></li>
<li><p>Overall idea: predicted price = intercept + <span class="math notranslate nohighlight">\(\sum_i\)</span> coefficient i <span class="math notranslate nohighlight">\(\times\)</span> feature i.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">Ridge</span><span class="p">())</span>
<span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s look at the coefficients.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">lr</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;ridge&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">new_columns</span><span class="p">,</span> 
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">])</span>
<span class="n">lr_coefs</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BedroomAbvGr</th>
      <td>-3723.741570</td>
    </tr>
    <tr>
      <th>KitchenAbvGr</th>
      <td>-4580.204576</td>
    </tr>
    <tr>
      <th>LotFrontage</th>
      <td>-1578.664421</td>
    </tr>
    <tr>
      <th>LotArea</th>
      <td>5109.356718</td>
    </tr>
    <tr>
      <th>OverallQual</th>
      <td>12487.561839</td>
    </tr>
    <tr>
      <th>OverallCond</th>
      <td>4855.535334</td>
    </tr>
    <tr>
      <th>YearBuilt</th>
      <td>4226.684842</td>
    </tr>
    <tr>
      <th>YearRemodAdd</th>
      <td>324.664715</td>
    </tr>
    <tr>
      <th>MasVnrArea</th>
      <td>5251.325210</td>
    </tr>
    <tr>
      <th>BsmtFinSF1</th>
      <td>3667.172851</td>
    </tr>
    <tr>
      <th>BsmtFinSF2</th>
      <td>583.114880</td>
    </tr>
    <tr>
      <th>BsmtUnfSF</th>
      <td>-1266.614671</td>
    </tr>
    <tr>
      <th>TotalBsmtSF</th>
      <td>2751.084018</td>
    </tr>
    <tr>
      <th>1stFlrSF</th>
      <td>6736.788904</td>
    </tr>
    <tr>
      <th>2ndFlrSF</th>
      <td>13409.901084</td>
    </tr>
    <tr>
      <th>LowQualFinSF</th>
      <td>-448.424132</td>
    </tr>
    <tr>
      <th>GrLivArea</th>
      <td>15988.182407</td>
    </tr>
    <tr>
      <th>BsmtFullBath</th>
      <td>2299.227266</td>
    </tr>
    <tr>
      <th>BsmtHalfBath</th>
      <td>500.169112</td>
    </tr>
    <tr>
      <th>FullBath</th>
      <td>2831.811467</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="interpreting-coefficients-of-different-types-of-features">
<h3>Interpreting coefficients of different types of features.<a class="headerlink" href="#interpreting-coefficients-of-different-types-of-features" title="Permalink to this headline">#</a></h3>
</section>
<section id="ordinal-features">
<h3>Ordinal features<a class="headerlink" href="#ordinal-features" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>The ordinal features are easiest to interpret.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ordinal_features_reg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;ExterQual&#39;, &#39;ExterCond&#39;, &#39;BsmtQual&#39;, &#39;BsmtCond&#39;, &#39;HeatingQC&#39;, &#39;KitchenQual&#39;, &#39;FireplaceQu&#39;, &#39;GarageQual&#39;, &#39;GarageCond&#39;, &#39;PoolQC&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;ExterQual&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficient    4195.671512
Name: ExterQual, dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Increasing by one category of exterior quality (e.g. good -&gt; excellent) increases the predicted price by <span class="math notranslate nohighlight">\(\sim\$4195\)</span>.</p>
<ul>
<li><p>Wow, that’s a lot!</p></li>
<li><p>Remember this is just what the model has learned. It doesn’t tell us how the world works.</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_example</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_example</span><span class="p">[[</span><span class="s2">&quot;ExterQual&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ExterQual</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>147</th>
      <td>Gd</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Let’s perturb the example and change <code class="docutils literal notranslate"><span class="pre">ExterQual</span></code> to <code class="docutils literal notranslate"><span class="pre">Ex</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_example_perturbed</span> <span class="o">=</span> <span class="n">one_example</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">one_example_perturbed</span><span class="p">[</span><span class="s2">&quot;ExterQual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Ex&quot;</span>  <span class="c1"># Change Gd to Ex</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_example_perturbed</span><span class="p">[[</span><span class="s2">&quot;ExterQual&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ExterQual</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>147</th>
      <td>Ex</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>How does the prediction change after changing <code class="docutils literal notranslate"><span class="pre">ExterQual</span></code> from <code class="docutils literal notranslate"><span class="pre">Gd</span></code> to <code class="docutils literal notranslate"><span class="pre">Ex</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prediction on the original example: &quot;</span><span class="p">,</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">one_example</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Prediction on the perturbed example: &quot;</span><span class="p">,</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">one_example_perturbed</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;After changing ExterQual from Gd to Ex increased the prediction by: &quot;</span><span class="p">,</span>
    <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">one_example_perturbed</span><span class="p">)</span> <span class="o">-</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">one_example</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Prediction on the original example:  [224795.63596803]
Prediction on the perturbed example:  [228991.30748049]
After changing ExterQual from Gd to Ex increased the prediction by:  [4195.67151247]
</pre></div>
</div>
</div>
</div>
<p>That’s exactly the learned coefficient for <code class="docutils literal notranslate"><span class="pre">ExterQual</span></code>!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;ExterQual&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficient    4195.671512
Name: ExterQual, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>So our interpretation is correct!</p>
<ul class="simple">
<li><p>Increasing by one category of exterior quality (e.g. good -&gt; excellent) increases the predicted price by <span class="math notranslate nohighlight">\(\sim\$4195\)</span>.</p></li>
</ul>
</section>
<section id="categorical-features">
<h3>Categorical features<a class="headerlink" href="#categorical-features" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>What about the categorical features?</p></li>
<li><p>We have created a number of columns for each category with OHE and each category gets it’s own coefficient.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;Exterior1st&#39;, &#39;MasVnrType&#39;, &#39;Utilities&#39;, &#39;BldgType&#39;, &#39;LandSlope&#39;, &#39;MiscFeature&#39;, &#39;SaleType&#39;, &#39;Exterior2nd&#39;, &#39;GarageFinish&#39;, &#39;RoofStyle&#39;, &#39;RoofMatl&#39;, &#39;LotShape&#39;, &#39;Alley&#39;, &#39;Heating&#39;, &#39;Electrical&#39;, &#39;CentralAir&#39;, &#39;GarageType&#39;, &#39;Condition1&#39;, &#39;SaleCondition&#39;, &#39;LandContour&#39;, &#39;LotConfig&#39;, &#39;HouseStyle&#39;, &#39;Condition2&#39;, &#39;MSSubClass&#39;, &#39;Neighborhood&#39;, &#39;MoSold&#39;, &#39;MSZoning&#39;, &#39;Street&#39;, &#39;Foundation&#39;, &#39;PavedDrive&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs_landslope</span> <span class="o">=</span> <span class="n">lr_coefs</span><span class="p">[</span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;LandSlope&quot;</span><span class="p">)]</span>
<span class="n">lr_coefs_landslope</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>LandSlope_Gtl</th>
      <td>457.197456</td>
    </tr>
    <tr>
      <th>LandSlope_Mod</th>
      <td>7420.208381</td>
    </tr>
    <tr>
      <th>LandSlope_Sev</th>
      <td>-7877.405837</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>We can talk about switching from one of these categories to another by picking a “reference” category:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs_landslope</span> <span class="o">-</span> <span class="n">lr_coefs_landslope</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;LandSlope_Gtl&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>LandSlope_Gtl</th>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>LandSlope_Mod</th>
      <td>6963.010925</td>
    </tr>
    <tr>
      <th>LandSlope_Sev</th>
      <td>-8334.603292</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>If you change the category from <code class="docutils literal notranslate"><span class="pre">LandSlope_Gtl</span></code> to <code class="docutils literal notranslate"><span class="pre">LandSlope_Mod</span></code> the prediction price goes up by <span class="math notranslate nohighlight">\(\sim\$6963\)</span></p></li>
<li><p>If you change the category from <code class="docutils literal notranslate"><span class="pre">LandSlope_Gtl</span></code> to <code class="docutils literal notranslate"><span class="pre">LandSlope_Sev</span></code> the prediction price goes down by <span class="math notranslate nohighlight">\(\sim\$8334\)</span></p></li>
</ul>
<p>Note that this might not make sense in the real world but this is what our model decided to learn given this small amount of data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Coefficient&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>RoofMatl_ClyTile</th>
      <td>-191129.774314</td>
    </tr>
    <tr>
      <th>Condition2_PosN</th>
      <td>-105552.840565</td>
    </tr>
    <tr>
      <th>Heating_OthW</th>
      <td>-27260.681308</td>
    </tr>
    <tr>
      <th>MSZoning_C (all)</th>
      <td>-21990.746193</td>
    </tr>
    <tr>
      <th>Exterior1st_ImStucc</th>
      <td>-19393.964621</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>PoolQC</th>
      <td>34217.656047</td>
    </tr>
    <tr>
      <th>RoofMatl_CompShg</th>
      <td>36525.980874</td>
    </tr>
    <tr>
      <th>Neighborhood_NridgHt</th>
      <td>37532.643270</td>
    </tr>
    <tr>
      <th>Neighborhood_StoneBr</th>
      <td>39993.978324</td>
    </tr>
    <tr>
      <th>RoofMatl_WdShngl</th>
      <td>83646.711008</td>
    </tr>
  </tbody>
</table>
<p>263 rows × 1 columns</p>
</div></div></div>
</div>
<ul class="simple">
<li><p>For example, the above coefficient says that “If the roof is made of clay or tile, the predicted price is \$191K less”?</p></li>
<li><p>Do we believe these interpretations??</p>
<ul>
<li><p>Do we believe this is how the predictions are being computed? Yes.</p></li>
<li><p>Do we believe that this is how the world works? No.</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you did <code class="docutils literal notranslate"><span class="pre">drop='first'</span></code> (we didn’t) then you already have a reference class, and all the values are with respect to that one. The interpretation depends on whether we did <code class="docutils literal notranslate"><span class="pre">drop='first'</span></code>, hence the hassle.</p>
</div>
</section>
<section id="interpreting-coefficients-of-numeric-features">
<h3>Interpreting coefficients of numeric features<a class="headerlink" href="#interpreting-coefficients-of-numeric-features" title="Permalink to this headline">#</a></h3>
<p>Let’s look at coefficients of <code class="docutils literal notranslate"><span class="pre">PoolArea</span></code>, <code class="docutils literal notranslate"><span class="pre">LotFrontage</span></code>, <code class="docutils literal notranslate"><span class="pre">LotArea</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;PoolArea&quot;</span><span class="p">,</span> <span class="s2">&quot;LotFrontage&quot;</span><span class="p">,</span> <span class="s2">&quot;LotArea&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>PoolArea</th>
      <td>2822.370476</td>
    </tr>
    <tr>
      <th>LotFrontage</th>
      <td>-1578.664421</td>
    </tr>
    <tr>
      <th>LotArea</th>
      <td>5109.356718</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Intuition:</p>
<ul class="simple">
<li><p>Tricky because numeric features are <strong>scaled</strong>!</p></li>
<li><p><strong>Increasing</strong> <code class="docutils literal notranslate"><span class="pre">PoolArea</span></code> by 1 scaled unit <strong>increases</strong> the predicted price by <span class="math notranslate nohighlight">\(\sim\$2822\)</span>.</p></li>
<li><p><strong>Increasing</strong> <code class="docutils literal notranslate"><span class="pre">LotArea</span></code> by 1 scaled unit <strong>increases</strong> the predicted price by <span class="math notranslate nohighlight">\(\sim\$5109\)</span>.</p></li>
<li><p><strong>Increasing</strong> <code class="docutils literal notranslate"><span class="pre">LotFrontage</span></code> by 1 scaled unit <strong>decreases</strong> the predicted price by <span class="math notranslate nohighlight">\(\sim\$1578\)</span>.</p></li>
</ul>
<p>Does that sound reasonable?</p>
<ul class="simple">
<li><p>For <code class="docutils literal notranslate"><span class="pre">PoolArea</span></code> and <code class="docutils literal notranslate"><span class="pre">LotArea</span></code>, yes.</p></li>
<li><p>For <code class="docutils literal notranslate"><span class="pre">LotFrontage</span></code>, that’s surprising. Something positive would have made more sense?</p></li>
</ul>
<p>It’s not the case that <code class="docutils literal notranslate"><span class="pre">LotFrontage</span></code> is correlated with some other variable, which might have a larger positive coefficient.</p>
<p>BTW, let’s make sure the predictions behave as expected:</p>
<section id="example-showing-how-can-we-interpret-coefficients-of-scaled-features">
<h4>Example showing how can we interpret coefficients of scaled features.<a class="headerlink" href="#example-showing-how-can-we-interpret-coefficients-of-scaled-features" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>What’s one scaled unit for <code class="docutils literal notranslate"><span class="pre">LotArea</span></code>?</p></li>
<li><p>The scaler subtracted the mean and divided by the standard deviation.</p></li>
<li><p>The division actually changed the scale!</p></li>
<li><p>For the unit conversion, we don’t care about the subtraction, but only the scaling.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;pipeline-1&quot;</span><span class="p">][</span><span class="s2">&quot;standardscaler&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_scales</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">scaler</span><span class="o">.</span><span class="n">var_</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">numeric_features</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Scale&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">lr_scales</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Scale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>BedroomAbvGr</th>
      <td>0.821040</td>
    </tr>
    <tr>
      <th>KitchenAbvGr</th>
      <td>0.218760</td>
    </tr>
    <tr>
      <th>LotFrontage</th>
      <td>20.959139</td>
    </tr>
    <tr>
      <th>LotArea</th>
      <td>8994.471032</td>
    </tr>
    <tr>
      <th>OverallQual</th>
      <td>1.392082</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>It seems like <code class="docutils literal notranslate"><span class="pre">LotArea</span></code> was divided by 8994.471032 sqft.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;LotArea&quot;</span><span class="p">,</span> <span class="s2">&quot;Coefficient&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5109.356718094055
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;LotArea&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>LotArea</th>
      <td>5109.356718</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>The coefficient tells us that if we increase the <strong>scaled</strong> <code class="docutils literal notranslate"><span class="pre">LotArea</span></code> by one scaled unit the price would go up by <span class="math notranslate nohighlight">\(\approx\$5109\)</span>.</p></li>
<li><p>One scaled unit represents <span class="math notranslate nohighlight">\(\sim 8994\)</span> sq feet.</p></li>
</ul>
<ul class="simple">
<li><p>So if I increase original <code class="docutils literal notranslate"><span class="pre">LotArea</span></code> by one square foot then the predicted price would go up by this amount:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mf">5109.356718094072</span> <span class="o">/</span> <span class="mf">8994.471032</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.5680552752814816
</pre></div>
</div>
</div>
</div>
<p>Let’s examine whether this works as expected. In other words</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_example</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_example</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Id</th>
      <th>MSSubClass</th>
      <th>MSZoning</th>
      <th>LotFrontage</th>
      <th>LotArea</th>
      <th>Street</th>
      <th>Alley</th>
      <th>LotShape</th>
      <th>LandContour</th>
      <th>Utilities</th>
      <th>...</th>
      <th>ScreenPorch</th>
      <th>PoolArea</th>
      <th>PoolQC</th>
      <th>Fence</th>
      <th>MiscFeature</th>
      <th>MiscVal</th>
      <th>MoSold</th>
      <th>YrSold</th>
      <th>SaleType</th>
      <th>SaleCondition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>147</th>
      <td>148</td>
      <td>60</td>
      <td>RL</td>
      <td>NaN</td>
      <td>9505</td>
      <td>Pave</td>
      <td>NaN</td>
      <td>IR1</td>
      <td>Lvl</td>
      <td>AllPub</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>5</td>
      <td>2010</td>
      <td>WD</td>
      <td>Normal</td>
    </tr>
  </tbody>
</table>
<p>1 rows × 80 columns</p>
</div></div></div>
</div>
<p>Let’s perturb the example and add 1 to the <code class="docutils literal notranslate"><span class="pre">LotArea</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_example_perturbed</span> <span class="o">=</span> <span class="n">one_example</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">one_example_perturbed</span><span class="p">[</span><span class="s2">&quot;LotArea&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># add 1 to the LotArea</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">one_example_perturbed</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Id</th>
      <th>MSSubClass</th>
      <th>MSZoning</th>
      <th>LotFrontage</th>
      <th>LotArea</th>
      <th>Street</th>
      <th>Alley</th>
      <th>LotShape</th>
      <th>LandContour</th>
      <th>Utilities</th>
      <th>...</th>
      <th>ScreenPorch</th>
      <th>PoolArea</th>
      <th>PoolQC</th>
      <th>Fence</th>
      <th>MiscFeature</th>
      <th>MiscVal</th>
      <th>MoSold</th>
      <th>YrSold</th>
      <th>SaleType</th>
      <th>SaleCondition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>147</th>
      <td>148</td>
      <td>60</td>
      <td>RL</td>
      <td>NaN</td>
      <td>9506</td>
      <td>Pave</td>
      <td>NaN</td>
      <td>IR1</td>
      <td>Lvl</td>
      <td>AllPub</td>
      <td>...</td>
      <td>0</td>
      <td>0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
      <td>5</td>
      <td>2010</td>
      <td>WD</td>
      <td>Normal</td>
    </tr>
  </tbody>
</table>
<p>1 rows × 80 columns</p>
</div></div></div>
</div>
<p>Prediction on the original example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">one_example</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([224795.63596803])
</pre></div>
</div>
</div>
</div>
<p>Prediction on the perturbed example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">one_example_perturbed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([224796.2040233])
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>What’s the difference between prediction?</p></li>
<li><p>Does the difference make sense given the coefficient of the feature?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">one_example_perturbed</span><span class="p">)</span> <span class="o">-</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">one_example</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.56805528])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lr_coefs</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;LotArea&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coefficient</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>LotArea</th>
      <td>5109.356718</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>That said don’t read too much into these coefficients without statistical training.</p></li>
</ul>
</section>
</section>
<section id="interim-summary">
<h3>Interim summary<a class="headerlink" href="#interim-summary" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Correlation among features might make coefficients completely uninterpretable.</p></li>
<li><p>Fairly straightforward to interpret coefficients of ordinal features.</p></li>
<li><p>In categorical features, it’s often helpful to consider one category as a reference point and think about relative importance.</p></li>
<li><p>For numeric features, relative importance is meaningful after scaling.</p></li>
<li><p>You have to be careful about the scale of the feature when interpreting the coefficients.</p></li>
<li><p>Remember that explaining the model <span class="math notranslate nohighlight">\(\neq\)</span> explaining the data.</p></li>
<li><p>The coefficients tell us only about the model and they might not accurately reflect the data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">yellowbrick.model_selection</span> <span class="kn">import</span> <span class="n">rfecv</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>

<span class="n">visualizer</span> <span class="o">=</span> <span class="n">rfecv</span><span class="p">(</span><span class="n">Ridge</span><span class="p">(),</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;r2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">46</span><span class="p">],</span> <span class="n">line</span> <span class="mi">5</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">visualizer</span> <span class="o">=</span> <span class="n">rfecv</span><span class="p">(</span><span class="n">Ridge</span><span class="p">(),</span> <span class="n">X</span><span class="o">=</span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;r2&#39;</span><span class="p">)</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/yellowbrick/model_selection/rfecv.py:357,</span> in <span class="ni">rfecv</span><span class="nt">(estimator, X, y, ax, step, groups, cv, scoring, show, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">352</span> <span class="n">oz</span> <span class="o">=</span> <span class="n">RFECV</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span>     <span class="n">estimator</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span>
<span class="g g-Whitespace">    </span><span class="mi">354</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span> <span class="c1"># Fit and show the visualizer</span>
<span class="ne">--&gt; </span><span class="mi">357</span> <span class="n">oz</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">359</span> <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">360</span>     <span class="n">oz</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/yellowbrick/model_selection/rfecv.py:197,</span> in <span class="ni">RFECV.fit</span><span class="nt">(self, X, y)</span>
<span class="g g-Whitespace">    </span><span class="mi">195</span> <span class="k">for</span> <span class="n">n_features_to_select</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_feature_subsets_</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">196</span>     <span class="n">rfe</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">n_features_to_select</span><span class="o">=</span><span class="n">n_features_to_select</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">197</span>     <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">rfe</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">cv_params</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span> <span class="c1"># Convert scores to array</span>
<span class="g g-Whitespace">    </span><span class="mi">200</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_scores_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/model_selection/_validation.py:515,</span> in <span class="ni">cross_val_score</span><span class="nt">(estimator, X, y, groups, scoring, cv, n_jobs, verbose, fit_params, pre_dispatch, error_score)</span>
<span class="g g-Whitespace">    </span><span class="mi">512</span> <span class="c1"># To ensure multimetric format is not supported</span>
<span class="g g-Whitespace">    </span><span class="mi">513</span> <span class="n">scorer</span> <span class="o">=</span> <span class="n">check_scoring</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">515</span> <span class="n">cv_results</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">516</span>     <span class="n">estimator</span><span class="o">=</span><span class="n">estimator</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">517</span>     <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">518</span>     <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">519</span>     <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">520</span>     <span class="n">scoring</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">scorer</span><span class="p">},</span>
<span class="g g-Whitespace">    </span><span class="mi">521</span>     <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">522</span>     <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">523</span>     <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">524</span>     <span class="n">fit_params</span><span class="o">=</span><span class="n">fit_params</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">525</span>     <span class="n">pre_dispatch</span><span class="o">=</span><span class="n">pre_dispatch</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">526</span>     <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">527</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span> <span class="k">return</span> <span class="n">cv_results</span><span class="p">[</span><span class="s2">&quot;test_score&quot;</span><span class="p">]</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/model_selection/_validation.py:266,</span> in <span class="ni">cross_validate</span><span class="nt">(estimator, X, y, groups, scoring, cv, n_jobs, verbose, fit_params, pre_dispatch, return_train_score, return_estimator, error_score)</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span> <span class="c1"># We clone the estimator to make sure that all the folds are</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span> <span class="c1"># independent, and that it is pickle-able.</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span> <span class="n">parallel</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">pre_dispatch</span><span class="o">=</span><span class="n">pre_dispatch</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">266</span> <span class="n">results</span> <span class="o">=</span> <span class="n">parallel</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="n">delayed</span><span class="p">(</span><span class="n">_fit_and_score</span><span class="p">)(</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>         <span class="n">clone</span><span class="p">(</span><span class="n">estimator</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>         <span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>         <span class="n">y</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span>         <span class="n">scorers</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">272</span>         <span class="n">train</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">273</span>         <span class="n">test</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">274</span>         <span class="n">verbose</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">275</span>         <span class="kc">None</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">276</span>         <span class="n">fit_params</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">277</span>         <span class="n">return_train_score</span><span class="o">=</span><span class="n">return_train_score</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">278</span>         <span class="n">return_times</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">279</span>         <span class="n">return_estimator</span><span class="o">=</span><span class="n">return_estimator</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">280</span>         <span class="n">error_score</span><span class="o">=</span><span class="n">error_score</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">281</span>     <span class="p">)</span>
<span class="nn">    282     for train, test</span> in <span class="ni">cv.split</span><span class="nt">(X, y, groups)</span>
<span class="g g-Whitespace">    </span><span class="mi">283</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">285</span> <span class="n">_warn_or_raise_about_fit_failures</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">error_score</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span> <span class="c1"># For callabe scoring, the return type is only know after calling. If the</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> <span class="c1"># return type is a dictionary, the error scores can now be inserted with</span>
<span class="g g-Whitespace">    </span><span class="mi">289</span> <span class="c1"># the correct key.</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/joblib/parallel.py:1043,</span> in <span class="ni">Parallel.__call__</span><span class="nt">(self, iterable)</span>
<span class="g g-Whitespace">   </span><span class="mi">1034</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1035</span>     <span class="c1"># Only set self._iterating to True if at least a batch</span>
<span class="g g-Whitespace">   </span><span class="mi">1036</span>     <span class="c1"># was dispatched. In particular this covers the edge</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1040</span>     <span class="c1"># was very quick and its callback already dispatched all the</span>
<span class="g g-Whitespace">   </span><span class="mi">1041</span>     <span class="c1"># remaining jobs.</span>
<span class="g g-Whitespace">   </span><span class="mi">1042</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_iterating</span> <span class="o">=</span> <span class="kc">False</span>
<span class="ne">-&gt; </span><span class="mi">1043</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_one_batch</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1044</span>         <span class="bp">self</span><span class="o">.</span><span class="n">_iterating</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_original_iterator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1046</span>     <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_one_batch</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/joblib/parallel.py:861,</span> in <span class="ni">Parallel.dispatch_one_batch</span><span class="nt">(self, iterator)</span>
<span class="g g-Whitespace">    </span><span class="mi">859</span>     <span class="k">return</span> <span class="kc">False</span>
<span class="g g-Whitespace">    </span><span class="mi">860</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">861</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">862</span>     <span class="k">return</span> <span class="kc">True</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/joblib/parallel.py:779,</span> in <span class="ni">Parallel._dispatch</span><span class="nt">(self, batch)</span>
<span class="g g-Whitespace">    </span><span class="mi">777</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">778</span>     <span class="n">job_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">779</span>     <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">cb</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">780</span>     <span class="c1"># A job can complete so quickly than its callback is</span>
<span class="g g-Whitespace">    </span><span class="mi">781</span>     <span class="c1"># called before we get here, causing self._jobs to</span>
<span class="g g-Whitespace">    </span><span class="mi">782</span>     <span class="c1"># grow. To ensure correct results ordering, .insert is</span>
<span class="g g-Whitespace">    </span><span class="mi">783</span>     <span class="c1"># used (rather than .append) in the following line</span>
<span class="g g-Whitespace">    </span><span class="mi">784</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_jobs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">job_idx</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/joblib/_parallel_backends.py:208,</span> in <span class="ni">SequentialBackend.apply_async</span><span class="nt">(self, func, callback)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span> <span class="k">def</span> <span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>     <span class="sd">&quot;&quot;&quot;Schedule a func to be run&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">208</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">ImmediateResult</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>     <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>         <span class="n">callback</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/joblib/_parallel_backends.py:572,</span> in <span class="ni">ImmediateResult.__init__</span><span class="nt">(self, batch)</span>
<span class="g g-Whitespace">    </span><span class="mi">569</span> <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">570</span>     <span class="c1"># Don&#39;t delay the application, to avoid keeping the input</span>
<span class="g g-Whitespace">    </span><span class="mi">571</span>     <span class="c1"># arguments in memory</span>
<span class="ne">--&gt; </span><span class="mi">572</span>     <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">batch</span><span class="p">()</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/joblib/parallel.py:262,</span> in <span class="ni">BatchedCalls.__call__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">258</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">259</span>     <span class="c1"># Set the default nested backend to self._backend but do not set the</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>     <span class="c1"># change the default number of processes to -1</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>     <span class="k">with</span> <span class="n">parallel_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">262</span>         <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span>                 <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/joblib/parallel.py:262,</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">    </span><span class="mi">258</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">259</span>     <span class="c1"># Set the default nested backend to self._backend but do not set the</span>
<span class="g g-Whitespace">    </span><span class="mi">260</span>     <span class="c1"># change the default number of processes to -1</span>
<span class="g g-Whitespace">    </span><span class="mi">261</span>     <span class="k">with</span> <span class="n">parallel_backend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_backend</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_jobs</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">262</span>         <span class="k">return</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">263</span>                 <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">]</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/utils/fixes.py:117,</span> in <span class="ni">_FuncWrapper.__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>     <span class="k">with</span> <span class="n">config_context</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">117</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/model_selection/_validation.py:686,</span> in <span class="ni">_fit_and_score</span><span class="nt">(estimator, X, y, scorer, train, test, verbose, parameters, fit_params, return_train_score, return_parameters, return_n_test_samples, return_times, return_estimator, split_progress, candidate_progress, error_score)</span>
<span class="g g-Whitespace">    </span><span class="mi">684</span>         <span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">685</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">686</span>         <span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">688</span> <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">689</span>     <span class="c1"># Note fit time as time until error</span>
<span class="g g-Whitespace">    </span><span class="mi">690</span>     <span class="n">fit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/feature_selection/_rfe.py:235,</span> in <span class="ni">RFE.fit</span><span class="nt">(self, X, y, **fit_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">215</span> <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span>     <span class="sd">&quot;&quot;&quot;Fit the RFE model and then the underlying estimator on the selected features.</span>
<span class="g g-Whitespace">    </span><span class="mi">217</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">218</span><span class="sd">     Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span><span class="sd">         Fitted estimator.</span>
<span class="g g-Whitespace">    </span><span class="mi">234</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">235</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/feature_selection/_rfe.py:296,</span> in <span class="ni">RFE._fit</span><span class="nt">(self, X, y, step_score, **fit_params)</span>
<span class="g g-Whitespace">    </span><span class="mi">293</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">294</span>     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting estimator with </span><span class="si">%d</span><span class="s2"> features.&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">support_</span><span class="p">))</span>
<span class="ne">--&gt; </span><span class="mi">296</span> <span class="n">estimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">features</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_params</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span> <span class="c1"># Get importance and rank them</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span> <span class="n">importances</span> <span class="o">=</span> <span class="n">_get_feature_importances</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">300</span>     <span class="n">estimator</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">301</span>     <span class="bp">self</span><span class="o">.</span><span class="n">importance_getter</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">302</span>     <span class="n">transform_func</span><span class="o">=</span><span class="s2">&quot;square&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">303</span> <span class="p">)</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/linear_model/_ridge.py:1130,</span> in <span class="ni">Ridge.fit</span><span class="nt">(self, X, y, sample_weight)</span>
<span class="g g-Whitespace">   </span><span class="mi">1121</span> <span class="n">_accept_sparse</span> <span class="o">=</span> <span class="n">_get_valid_accept_sparse</span><span class="p">(</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1122</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1123</span>     <span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1124</span>     <span class="n">y</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1128</span>     <span class="n">y_numeric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1129</span> <span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1130</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/linear_model/_ridge.py:889,</span> in <span class="ni">_BaseRidge.fit</span><span class="nt">(self, X, y, sample_weight)</span>
<span class="g g-Whitespace">    </span><span class="mi">885</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">886</span>         <span class="c1"># for dense matrices or when intercept is set to 0</span>
<span class="g g-Whitespace">    </span><span class="mi">887</span>         <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
<span class="ne">--&gt; </span><span class="mi">889</span>     <span class="bp">self</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_iter_</span> <span class="o">=</span> <span class="n">_ridge_regression</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">890</span>         <span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">891</span>         <span class="n">y</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">892</span>         <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">893</span>         <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">894</span>         <span class="n">max_iter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">895</span>         <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tol</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">896</span>         <span class="n">solver</span><span class="o">=</span><span class="n">solver</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">897</span>         <span class="n">positive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">positive</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">898</span>         <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">899</span>         <span class="n">return_n_iter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">900</span>         <span class="n">return_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">901</span>         <span class="n">check_input</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">902</span>         <span class="n">fit_intercept</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_intercept</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">903</span>         <span class="o">**</span><span class="n">params</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">904</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">905</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_set_intercept</span><span class="p">(</span><span class="n">X_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">,</span> <span class="n">X_scale</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">907</span> <span class="k">return</span> <span class="bp">self</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/linear_model/_ridge.py:699,</span> in <span class="ni">_ridge_regression</span><span class="nt">(X, y, alpha, sample_weight, solver, max_iter, tol, verbose, positive, random_state, return_n_iter, return_intercept, X_scale, X_offset, check_input, fit_intercept)</span>
<span class="g g-Whitespace">    </span><span class="mi">697</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">698</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">699</span>         <span class="n">coef</span> <span class="o">=</span> <span class="n">_solve_cholesky</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span>     <span class="k">except</span> <span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">701</span>         <span class="c1"># use SVD solver if matrix is singular</span>
<span class="g g-Whitespace">    </span><span class="mi">702</span>         <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;svd&quot;</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/linear_model/_ridge.py:205,</span> in <span class="ni">_solve_cholesky</span><span class="nt">(X, y, alpha)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> <span class="n">n_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span> <span class="n">n_targets</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">205</span> <span class="n">A</span> <span class="o">=</span> <span class="n">safe_sparse_dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span> <span class="n">Xy</span> <span class="o">=</span> <span class="n">safe_sparse_dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span> <span class="n">one_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/sklearn/utils/extmath.py:155,</span> in <span class="ni">safe_sparse_dot</span><span class="nt">(a, b, dense_output)</span>
<span class="g g-Whitespace">    </span><span class="mi">151</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">152</span>     <span class="n">ret</span> <span class="o">=</span> <span class="n">a</span> <span class="o">@</span> <span class="n">b</span>
<span class="g g-Whitespace">    </span><span class="mi">154</span> <span class="k">if</span> <span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">155</span>     <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">156</span>     <span class="ow">and</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">157</span>     <span class="ow">and</span> <span class="n">dense_output</span>
<span class="g g-Whitespace">    </span><span class="mi">158</span>     <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s2">&quot;toarray&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">159</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">160</span>     <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">161</span> <span class="k">return</span> <span class="n">ret</span>

<span class="nn">File ~/opt/miniconda3/envs/cpsc330/lib/python3.10/site-packages/scipy/sparse/_base.py:1301,</span> in <span class="ni">isspmatrix</span><span class="nt">(x)</span>
<span class="g g-Whitespace">   </span><span class="mi">1297</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1298</span>             <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1301</span> <span class="k">def</span> <span class="nf">isspmatrix</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1302</span>     <span class="sd">&quot;&quot;&quot;Is x of a sparse matrix type?</span>
<span class="g g-Whitespace">   </span><span class="mi">1303</span><span class="sd"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1304</span><span class="sd">     Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">   </span><span class="mi">1326</span><span class="sd">     False</span>
<span class="g g-Whitespace">   </span><span class="mi">1327</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1328</span>     <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spmatrix</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
<img alt="../_images/12_feat-importances_95_1.png" src="../_images/12_feat-importances_95_1.png" />
</div>
</div>
<p><br><br><br><br></p>
</section>
</section>
<section id="transparency-and-explainability-of-ml-models">
<h2>Transparency and explainability of ML models<a class="headerlink" href="#transparency-and-explainability-of-ml-models" title="Permalink to this headline">#</a></h2>
<p><img alt="" src="../_images/shap_example.png" /></p>
<!-- <img src="img/shap_example.png" width="600" height="600"> -->
<p><a class="reference external" href="https://github.com/slundberg/shap/blob/master/docs/presentations/February%202018%20Talk.pptx">Source</a></p>
<ul class="simple">
<li><p>What if it’s our Eva instead of John whose loan application gets rejected?</p></li>
</ul>
<p><img alt="" src="../_images/eva-qm.png" /></p>
<p><img alt="" src="../_images/shap_example.png" /></p>
<!-- <img src="img/shap_example.png" width="600" height="600"> -->
<section id="discussion">
<h3>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>If you have a machine learning model which gives you 98% cross-validation accuracy and 97% test accuracy on a reasonable sized train and test data on the task of your interest.</p></li>
<li><p>Is it OK to just trust the model and ignore why it made a certain prediction?</p></li>
<li><p>Discuss scenarios where this might be problematic.</p></li>
</ul>
</section>
<section id="why-do-we-care-about-transparency-and-interpretability">
<h3>Why do we care about transparency and interpretability?<a class="headerlink" href="#why-do-we-care-about-transparency-and-interpretability" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Transparency of ML model predictions is crucial in many applications such as banking, healthcare, and criminal justice.</p></li>
<li><p>It can be leveraged by domain experts to diagnose systematic errors and underlying biases of complex ML systems.</p></li>
</ul>
<p><img alt="" src="../_images/shap_example.png" /></p>
<!-- <img src="img/shap_example.png" width="600" height="600"> -->
<p><a class="reference external" href="https://github.com/slundberg/shap/blob/master/docs/presentations/February%202018%20Talk.pptx">Source</a></p>
</section>
<section id="what-is-model-interpretability">
<h3>What is model interpretability?<a class="headerlink" href="#what-is-model-interpretability" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>In this lecture, our definition of model interpretability will be looking at <strong>feature importances</strong>.</p></li>
<li><p>There is more to interpretability than feature importances, but it’s a good start!</p></li>
<li><p>Resource:</p>
<ul>
<li><p><a class="reference external" href="https://christophm.github.io/interpretable-ml-book/interpretability-importance.html">Interpretable Machine Learning</a></p></li>
<li><p><a class="reference external" href="https://vimeo.com/252187813">Yann LeCun, Kilian Weinberger, Patrice Simard, and Rich Caruana: Panel debate on interpretability</a></p></li>
</ul>
</li>
</ul>
<p><br><br></p>
</section>
<section id="id1">
<h3>Data<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Let’s work with <a class="reference external" href="https://www.kaggle.com/uciml/adult-census-income">the adult census data set</a> from last lecture.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adult_df_large</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/adult.csv&quot;</span><span class="p">)</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">adult_df_large</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">train_df</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
<span class="n">test_df</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
<span class="n">train_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;capital.gain&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="s2">&quot;capital.loss&quot;</span><span class="p">,</span> <span class="s2">&quot;hours.per.week&quot;</span><span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;marital.status&quot;</span><span class="p">,</span>
    <span class="s2">&quot;native.country&quot;</span><span class="p">,</span>
    <span class="s2">&quot;relationship&quot;</span><span class="p">,</span>
    <span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
    <span class="s2">&quot;workclass&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">ordinal_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span>
<span class="n">binary_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">]</span>
<span class="n">drop_features</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fnlwgt&quot;</span><span class="p">,</span> <span class="s2">&quot;race&quot;</span><span class="p">,</span> <span class="s2">&quot;education.num&quot;</span><span class="p">]</span>
<span class="n">target_column</span> <span class="o">=</span> <span class="s2">&quot;income&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">education_levels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Preschool&quot;</span><span class="p">,</span>
    <span class="s2">&quot;1st-4th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;5th-6th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;7th-8th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;9th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;10th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;11th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;12th&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HS-grad&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Prof-school&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Assoc-voc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Assoc-acdm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Some-college&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Bachelors&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Masters&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Doctorate&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">education_levels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">ordinal_transformer</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">(</span><span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="n">education_levels</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">binary_transformer</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s2">&quot;if_binary&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;missing&quot;</span><span class="p">),</span>
    <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">make_column_transformer</span><span class="p">(</span>
    <span class="p">(</span><span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">ordinal_transformer</span><span class="p">,</span> <span class="n">ordinal_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">binary_transformer</span><span class="p">,</span> <span class="n">binary_features</span><span class="p">),</span>
    <span class="p">(</span><span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">,</span> <span class="n">drop_features</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target_column</span><span class="p">])</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">target_column</span><span class="p">]</span>

<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">target_column</span><span class="p">])</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">target_column</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ohe_feats</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">numeric_features</span> <span class="o">+</span> <span class="n">ordinal_features</span> <span class="o">+</span> <span class="n">binary_features</span> <span class="o">+</span> <span class="n">ohe_feats</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="do-we-have-class-imbalance">
<h3>Do we have class imbalance?<a class="headerlink" href="#do-we-have-class-imbalance" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>There is class imbalance. But without any context, both classes seem equally important.</p></li>
<li><p>Let’s use accuracy as our metric.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_df</span><span class="p">[</span><span class="s2">&quot;income&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scoring_metric</span> <span class="o">=</span> <span class="s2">&quot;accuracy&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s store all the results in a dictionary called <code class="docutils literal notranslate"><span class="pre">results</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scoring_metric</span> <span class="o">=</span> <span class="s2">&quot;accuracy&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lightgbm.sklearn</span> <span class="kn">import</span> <span class="n">LGBMClassifier</span>

<span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">))</span>

<span class="n">pipe_lgbm</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">))</span>
<span class="n">classifiers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;logistic regression&quot;</span><span class="p">:</span> <span class="n">pipe_lr</span><span class="p">,</span>
    <span class="s2">&quot;random forest&quot;</span><span class="p">:</span> <span class="n">pipe_rf</span><span class="p">,</span>
    <span class="s2">&quot;LightGBM&quot;</span><span class="p">:</span> <span class="n">pipe_lgbm</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dummy</span> <span class="o">=</span> <span class="n">DummyClassifier</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;stratified&quot;</span><span class="p">)</span>
<span class="n">results</span><span class="p">[</span><span class="s2">&quot;Dummy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_std_cross_val_scores</span><span class="p">(</span>
    <span class="n">dummy</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring_metric</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span> <span class="ow">in</span> <span class="n">classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_std_cross_val_scores</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">return_train_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="n">scoring_metric</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Logistic regression is giving reasonable scores but not the best ones.</p></li>
<li><p>LightGBM is giving us the best CV scores.</p></li>
</ul>
<ul class="simple">
<li><p>Often simple models (e.g., linear models) are interpretable but not very accurate.</p></li>
<li><p>Complex models (e.g., LightGBM) are more accurate but less interpretable.</p></li>
</ul>
<p><img alt="" src="../_images/shap_motivation.png" /></p>
<!-- <img src="img/shap_motivation.png" width="600" height="600"> -->
<p><a class="reference external" href="https://github.com/slundberg/shap/blob/master/docs/presentations/February%202018%20Talk.pptx">Source</a></p>
</section>
</section>
<section id="break-5-min">
<h2>Break (5 min)<a class="headerlink" href="#break-5-min" title="Permalink to this headline">#</a></h2>
<p><img alt="" src="../_images/eva-coffee.png" /></p>
<p><br><br><br><br></p>
<section id="id2">
<h3>Feature importances in linear models<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Simpler models are often more interpretable but less accurate.</p></li>
</ul>
<p>Let’s create and fit a pipeline with preprocessor and logistic regression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">pipe_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ohe_feature_names</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pipe_rf</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;columntransformer&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;onehotencoder&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">get_feature_names</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">numeric_features</span> <span class="o">+</span> <span class="n">ordinal_features</span> <span class="o">+</span> <span class="n">binary_features</span> <span class="o">+</span> <span class="n">ohe_feature_names</span>
<span class="p">)</span>
<span class="n">feature_names</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;coefficient&quot;</span><span class="p">:</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;logisticregression&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span>
        <span class="n">pipe_lr</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;logisticregression&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="p">),</span>
<span class="p">}</span>
<span class="n">coef_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coef_df</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Increasing <code class="docutils literal notranslate"><span class="pre">capital.gain</span></code> is likely to push the prediction towards “&gt;50k” income class</p></li>
<li><p>Whereas occupation of private house service is likely to push the prediction towards “&lt;=50K” income.</p></li>
</ul>
<p>Can we get feature importances for non-linear models?</p>
</section>
</section>
<section id="model-interpretability-beyond-linear-models">
<h2>Model interpretability beyond linear models<a class="headerlink" href="#model-interpretability-beyond-linear-models" title="Permalink to this headline">#</a></h2>
<p>We will be looking at three ways for model interpretability.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sklearn</span></code> <code class="docutils literal notranslate"><span class="pre">feature_importances_</span></code></p></li>
<li><p><a class="reference external" href="https://eli5.readthedocs.io/en/latest/tutorials/black-box-text-classifiers.html#lime-tutorial">eli5</a> (stands for “explain like I’m 5”)</p></li>
<li><p><a class="reference external" href="https://github.com/slundberg/shap">SHAP</a></p></li>
</ul>
<section id="feature-importances-activity">
<h3>Feature importances activity<a class="headerlink" href="#feature-importances-activity" title="Permalink to this headline">#</a></h3>
<p>We have been talking about feature importances given by linear models. How about other models we have seen so far? What might be reasonable ways to calculate feature importances of other models we have seen so far?</p>
<ul class="simple">
<li><p>Decision trees</p></li>
<li><p>Other tree-based models such as random forests or LightGBM</p></li>
<li><p>Linear SVMs</p></li>
<li><p>KNNs, RBF SVMs</p></li>
</ul>
</section>
<section id="sklearn-feature-importances">
<h3><code class="docutils literal notranslate"><span class="pre">sklearn</span></code> <code class="docutils literal notranslate"><span class="pre">feature_importances_</span></code><a class="headerlink" href="#sklearn-feature-importances" title="Permalink to this headline">#</a></h3>
<section id="decision-tre-feature-importances">
<h4>Decision tre feature importances<a class="headerlink" href="#decision-tre-feature-importances" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_dt</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">pipe_dt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Importance&quot;</span><span class="p">:</span> <span class="n">pipe_dt</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;decisiontreeclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="s2">&quot;Importance&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tree</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">pipe_dt</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;decisiontreeclassifier&quot;</span><span class="p">],</span> <span class="n">counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s create and fit a pipeline with preprocessor and random forest.</p>
</section>
<section id="random-forest-feature-importances">
<h4>Random forest feature importances<a class="headerlink" href="#random-forest-feature-importances" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">pipe_rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Which features are driving the predictions the most?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Importance&quot;</span><span class="p">:</span> <span class="n">pipe_rf</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;randomforestclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">rf_imp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Importance&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_imp_df</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pipe_rf</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;randomforestclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="key-point">
<h3>Key point<a class="headerlink" href="#key-point" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Unlike the linear model coefficients, <code class="docutils literal notranslate"><span class="pre">feature_importances_</span></code> <strong>do not have a sign</strong>!</p>
<ul>
<li><p>They tell us about importance, but not an “up or down”.</p></li>
<li><p>Indeed, increasing a feature may cause the prediction to first go up, and then go down.</p></li>
<li><p>This cannot happen in linear models, because they are linear.</p></li>
</ul>
</li>
</ul>
<p>Do these importances match with importances identified by logistic regression?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;random forest importance&quot;</span><span class="p">:</span> <span class="n">pipe_rf</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span>
        <span class="s2">&quot;randomforestclassifier&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
    <span class="s2">&quot;logistic regression importances&quot;</span><span class="p">:</span> <span class="n">pipe_lr</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;logisticregression&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<span class="p">}</span>
<span class="n">imps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imps</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;random forest importance&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Both models agree on <code class="docutils literal notranslate"><span class="pre">age</span></code>, <code class="docutils literal notranslate"><span class="pre">education</span></code>, <code class="docutils literal notranslate"><span class="pre">capital.gain</span></code></p></li>
<li><p>The actual numbers for random forests and logistic regression are not really comparable.</p></li>
</ul>
</section>
<section id="how-can-we-get-feature-importances-for-non-sklearn-models">
<h3>How can we get feature importances for non <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> models?<a class="headerlink" href="#how-can-we-get-feature-importances-for-non-sklearn-models" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>One way to do it is by using a tool called <a class="reference external" href="https://eli5.readthedocs.io/en/latest/overview.html"><code class="docutils literal notranslate"><span class="pre">eli5</span></code></a>.</p></li>
</ul>
<p>I don’t recall whether I included in the course conda environment or not. If not, you’ll have to install it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="n">eli5</span>
</pre></div>
</div>
<p>Let’s look at feature importances for <code class="docutils literal notranslate"><span class="pre">LGBMClassifier</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">eli5</span>

<span class="n">pipe_lgbm</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">LGBMClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">))</span>
<span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">eli5</span><span class="o">.</span><span class="n">explain_weights</span><span class="p">(</span>
    <span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">],</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You can also look at feature importances for <code class="docutils literal notranslate"><span class="pre">RandomForestClassifier</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_rf</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">123</span><span class="p">))</span>
<span class="n">pipe_rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">eli5</span><span class="o">.</span><span class="n">explain_weights</span><span class="p">(</span>
    <span class="n">pipe_rf</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;randomforestclassifier&quot;</span><span class="p">],</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">feature_names</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s compare them with weights what we got with <code class="docutils literal notranslate"><span class="pre">sklearn</span></code> <code class="docutils literal notranslate"><span class="pre">feature_importances_</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Importance&quot;</span><span class="p">:</span> <span class="n">pipe_rf</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;randomforestclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="s2">&quot;Importance&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>These values tell us globally about which features are important.</p></li>
<li><p>But what if you want to explain a <em>specific</em> prediction.</p></li>
<li><p>Some fancier tools can help us do this.</p></li>
</ul>
<p><br><br><br><br></p>
</section>
<section id="shap-shapley-additive-explanations">
<h3>SHAP  (SHapley Additive exPlanations)<a class="headerlink" href="#shap-shapley-additive-explanations" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Based on the idea of shapely values. A shapely value is created for each example and each feature.</p></li>
<li><p>Can explain the prediction of an example by computing the contribution of each feature to the prediction.</p></li>
<li><p>Great visualizations</p></li>
<li><p>Support for different kinds of models; fast variants for tree-based models</p></li>
<li><p>Original paper: <a class="reference external" href="https://arxiv.org/pdf/1705.07874.pdf">Lundberg and Lee, 2017</a></p></li>
</ul>
<section id="our-focus">
<h4>Our focus<a class="headerlink" href="#our-focus" title="Permalink to this headline">#</a></h4>
<ul class="simple">
<li><p>How to use it on our dataset?</p></li>
<li><p>How to generate and interpret plots created by SHAP?</p></li>
<li><p>We are not going to discuss how SHAP works.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/shap_explanation2.png"><img alt="../_images/shap_explanation2.png" src="../_images/shap_explanation2.png" style="width: 1000px; height: 1000px;" /></a>
<p><a class="reference external" href="https://github.com/slundberg/shap/blob/master/docs/presentations/February%202018%20Talk.pptx">Source</a></p>
<ul class="simple">
<li><p>Start at a base rate (e.g., how often people get their loans rejected).</p></li>
<li><p>Add one feature at a time and see how it impacts the decision.</p></li>
</ul>
<ul class="simple">
<li><p>Let’s try it out on tree-based models.</p></li>
<li><p>Install <code class="docutils literal notranslate"><span class="pre">shap</span></code> in the course conda environment.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">install</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="n">shap</span>
</pre></div>
</div>
<p>Let’s create train and test dataframes with our transformed features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">X_train_enc</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test_enc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">),</span>
    <span class="n">columns</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
    <span class="n">index</span><span class="o">=</span><span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">X_test_enc</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s get SHAP values for train and test data.</p>
<p>To run the code below, you need to install SHAP as follows:</p>
<p><code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">install</span> <span class="pre">-c</span> <span class="pre">conda-forge</span> <span class="pre">shap</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shap</span>

<span class="n">lgbm_explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">])</span>
<span class="n">train_lgbm_shap_values</span> <span class="o">=</span> <span class="n">lgbm_explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X_train_enc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_lgbm_shap_values</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>For each example, each feature, and each class we have a SHAP value.</p></li>
<li><p>SHAP values tell us how to fairly distribute the prediction among features.</p></li>
<li><p>For classification it’s a bit confusing. It gives SHAP matrix for both classes.</p></li>
<li><p>Let’s stick to shap values for class 1, i.e., income &gt; 50K.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_lgbm_shap_values</span> <span class="o">=</span> <span class="n">lgbm_explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X_test_enc</span><span class="p">)</span>
<span class="n">test_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="shap-plots">
<h2>SHAP plots<a class="headerlink" href="#shap-plots" title="Permalink to this headline">#</a></h2>
<section id="force-plots">
<h3>Force plots<a class="headerlink" href="#force-plots" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Most useful!</p></li>
<li><p>Let’s try to explain predictions on a couple of examples from the test data.</p></li>
<li><p>I’m sampling some examples where target is &lt;=50K and some examples where target is &gt;50K.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_test_reset</span> <span class="o">=</span> <span class="n">y_test</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">y_test_reset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l50k_ind</span> <span class="o">=</span> <span class="n">y_test_reset</span><span class="p">[</span><span class="n">y_test_reset</span> <span class="o">==</span> <span class="s2">&quot;&lt;=50K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">g50k_ind</span> <span class="o">=</span> <span class="n">y_test_reset</span><span class="p">[</span><span class="n">y_test_reset</span> <span class="o">==</span> <span class="s2">&quot;&gt;50K&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">ex_l50k_index</span> <span class="o">=</span> <span class="n">l50k_ind</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
<span class="n">ex_g50k_index</span> <span class="o">=</span> <span class="n">g50k_ind</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-with-prediction-50k">
<h3>Example with prediction &lt;=50K<a class="headerlink" href="#example-with-prediction-50k" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">classes_</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_enc</span><span class="p">)[</span><span class="n">ex_l50k_index</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_enc</span><span class="p">,</span> <span class="n">raw_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span>
    <span class="n">ex_l50k_index</span>
<span class="p">]</span>  <span class="c1"># raw score of the model</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_enc</span><span class="p">,</span> <span class="n">raw_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_enc</span><span class="p">,</span> <span class="n">raw_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lgbm_explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># on average this is the raw score for class 1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lgbm_explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_test_enc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">X_test_enc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># for better visualization</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span>
    <span class="n">lgbm_explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">test_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ex_l50k_index</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">X_test_enc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ex_l50k_index</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>The raw model score is much smaller than the base value, which is reflected in the prediction of &lt;= 50k class.</p></li>
<li><p>sex = 1.0, scaled age = 0.48 are pushing the prediction towards higher score.</p></li>
<li><p>education = 8.0, occupation_Other-service = 1.0 and marital.status_Married-civ-spouse = 0.0 are pushing
the prediction towards lower score.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">test_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ex_l50k_index</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SHAP values&quot;</span><span class="p">],</span>
<span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;SHAP values&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>Example with prediction &gt;50K<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_enc</span><span class="p">)[</span><span class="n">ex_g50k_index</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipe_lgbm</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lgbmclassifier&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_enc</span><span class="p">,</span> <span class="n">raw_score</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span>
    <span class="n">ex_g50k_index</span>
<span class="p">]</span>  <span class="c1"># raw model score</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">test_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ex_g50k_index</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SHAP values&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span>
    <span class="n">lgbm_explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">test_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ex_g50k_index</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">X_test_enc</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ex_g50k_index</span><span class="p">,</span> <span class="p">:],</span>
    <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Observations:</p>
<ul class="simple">
<li><p>Everything is with respect to class 1 here.</p></li>
<li><p>The base value for class 1 is -2.316. (You can think of this as the raw score on average.)</p></li>
<li><p>We see the forces that drive the prediction.</p></li>
<li><p>That is, we can see the main factors pushing it from the base value (average over the dataset) to this particular prediction.</p></li>
<li><p>Features that push the prediction to a higher value are shown in red.</p></li>
<li><p>Features that push the prediction to a lower value are shown in blue.</p></li>
</ul>
<p>Note: a nice thing about SHAP values is that the feature importances sum to the prediction:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ex_g50k_index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">lgbm_explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="global-feature-importance-using-shap">
<h3>Global feature importance using SHAP<a class="headerlink" href="#global-feature-importance-using-shap" title="Permalink to this headline">#</a></h3>
<p>Let’s look at the average SHAP values associated with each feature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">train_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
    <span class="mi">0</span>
<span class="p">)</span>  <span class="c1"># mean of shapely values in each column</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SHAP&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
    <span class="n">by</span><span class="o">=</span><span class="s2">&quot;SHAP&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">train_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train_enc</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You can think of this as global feature importances.</p>
<p><br><br><br><br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load JS visualization code to notebook</span>
<span class="n">shap</span><span class="o">.</span><span class="n">initjs</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="dependence-plot">
<h3>Dependence plot<a class="headerlink" href="#dependence-plot" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">,</span> <span class="n">train_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train_enc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The plot above shows effect of <code class="docutils literal notranslate"><span class="pre">age</span></code> feature on the prediction.</p>
<ul class="simple">
<li><p>Each dot is a single prediction for examples above.</p></li>
<li><p>The x-axis represents values of the feature age (scaled).</p></li>
<li><p>The y-axis is the SHAP value for that feature, which represents how much knowing that feature’s value changes the output of the model for that example’s prediction.</p></li>
<li><p>Lower values of age have smaller SHAP values for class “&gt;50K”.</p></li>
<li><p>Similarly, higher values of age also have a bit smaller SHAP values for class “&gt;50K”, which makes sense.</p></li>
<li><p>There is some optimal value of age between scaled age of 1 which gives highest SHAP values for for class “&gt;50K”.</p></li>
<li><p>Ignore the colour for now. The color corresponds to a second feature (education feature in this case) that may have an interaction effect with the feature we are plotting.</p></li>
</ul>
</section>
<section id="summary-plot">
<h3>Summary plot<a class="headerlink" href="#summary-plot" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">train_lgbm_shap_values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X_train_enc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The plot shows the most important features for predicting the class. It also shows the direction of how it’s going to drive the prediction.</p>
<ul class="simple">
<li><p>Presence of the marital status of Married-civ-spouse seems to have bigger SHAP values for class 1 and absence seems to have smaller SHAP values for class 1.</p></li>
<li><p>Higher levels of education seem to have bigger SHAP values for class 1 whereas smaller levels of education have smaller SHAP values.</p></li>
</ul>
<p>Provides explainer for different kinds of models</p>
<ul class="simple">
<li><p><a class="reference external" href="https://shap.readthedocs.io/en/latest/">TreeExplainer</a> (supports XGBoost, CatBoost, LightGBM)</p></li>
<li><p><a class="reference external" href="https://shap.readthedocs.io/en/latest/index.html#shap.DeepExplainer">DeepExplainer</a> (supports deep-learning models)</p></li>
<li><p><a class="reference external" href="https://shap.readthedocs.io/en/latest/index.html#shap.KernelExplainer">KernelExplainer</a> (supports kernel-based models)</p></li>
<li><p><a class="reference external" href="https://shap.readthedocs.io/en/latest/index.html#shap.GradientExplainer">GradientExplainer</a> (supports Keras and Tensorflow models)</p></li>
</ul>
<ul class="simple">
<li><p>Can also be used to explain text classification and image classification</p></li>
<li><p>Example: In the picture below, red pixels represent positive SHAP values that increase the probability of the class, while blue pixels represent negative SHAP values the reduce the probability of the class.</p></li>
</ul>
<p><img alt="" src="../_images/shap_image_explainer.png" /></p>
<!-- <img src="img/shap_image_explainer.png" width="600" height="600"> -->
<p><a class="reference external" href="https://github.com/slundberg/shap">Source</a></p>
</section>
<section id="other-tools">
<h3>Other tools<a class="headerlink" href="#other-tools" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/marcotcr/lime">lime</a> is another package.</p></li>
</ul>
<p>If you’re not already impressed, keep in mind:</p>
<ul class="simple">
<li><p>So far we’ve only used sklearn models.</p></li>
<li><p>Most sklearn models have some built-in measure of feature importances.</p></li>
<li><p>On many tasks we need to move beyond sklearn, e.g. LightGBM, deep learning.</p></li>
<li><p>These tools work on other models as well, which makes them extremely useful.</p></li>
</ul>
<section id="why-do-we-want-this-information">
<h4>Why do we want this information?<a class="headerlink" href="#why-do-we-want-this-information" title="Permalink to this headline">#</a></h4>
<p>Possible reasons:</p>
<ul class="simple">
<li><p>Identify features that are not useful and maybe remove them.</p></li>
<li><p>Get guidance on what new data to collect.</p>
<ul>
<li><p>New features related to useful features -&gt; better results.</p></li>
<li><p>Don’t bother collecting useless features -&gt; save resources.</p></li>
</ul>
</li>
<li><p>Help explain why the model is making certain predictions.</p>
<ul>
<li><p>Debugging, if the model is behaving strangely.</p></li>
<li><p>Regulatory requirements.</p></li>
<li><p>Fairness / bias.</p></li>
<li><p>Keep in mind this can be used on <strong>deployment</strong> predictions!</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda-env-cpsc330-py"
        },
        kernelOptions: {
            kernelName: "conda-env-cpsc330-py",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda-env-cpsc330-py'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="11_ensembles.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Lecture 11: Ensembles</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="13_feature-engineering-selection.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 13: Feature engineering and feature selection</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Varada Kolhatkar<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>